#!/bin/sh

# ==============================================================================
# Spryker Prompt Rules Generator (sh compatible)
#
# This script fetches the latest prompting rules from the spryker-dev repository,
# combines them into a single file, customizes it based on user input (team role),
# and provides instructions for integrating it with a chosen IDE.
#
# Usage:
#   sh get-rules.sh
# ==============================================================================

# --- Configuration ---
# Space-separated string of remote URLs for the rule files (POSIX compatible)
RULE_URLS="https://raw.githubusercontent.com/spryker-dev/prompt-library/main/rules/shared/general.md https://raw.githubusercontent.com/spryker-dev/prompt-library/main/rules/shared/application-layers.md https://raw.githubusercontent.com/spryker-dev/prompt-library/main/rules/shared/layers.md https://raw.githubusercontent.com/spryker-dev/prompt-library/main/rules/shared/components.md"
# The final output file name
OUTPUT_FILE="spryker_prompt_rules.md"

# --- Helper Functions ---

# Function to print colored text
# Usage: print_color "TEXT" "COLOR"
print_color() {
    text="$1"
    color_name="$2"
    color_code=""
    case "$color_name" in
        green) color_code="\033[0;32m" ;;
        red)   color_code="\033[0;31m" ;;
        yellow)color_code="\033[0;33m" ;;
        blue)  color_code="\033[0;34m" ;;
        *)     color_code="\033[0m" ;; # Default/Reset
    esac
    reset_code="\033[0m"
    # Using printf for better portability than 'echo -e'
    printf "%b\n" "${color_code}${text}${reset_code}"
}

# Fetches and combines the rule files from the remote repository
fetch_and_combine_rules() {
    print_color "Fetching and combining Spryker prompting rules..." "blue"
    # Ensure the output file is empty before we start
    > "$OUTPUT_FILE"

    # Loop over space-separated string, which is POSIX compliant
    for url in $RULE_URLS; do
        echo " -> Downloading from ${url}"
        # Use curl to fetch the content and check for errors
        if ! curl -sL "$url" >> "$OUTPUT_FILE"; then
            print_color "Error: Failed to download rule file from ${url}" "red"
            exit 1
        fi
        # Add a separator for better readability between merged files
        printf "\n\n---\n\n" >> "$OUTPUT_FILE"
    done
    print_color "Successfully combined all rules into '${OUTPUT_FILE}'." "green"
}

# Prompts the user to select their team role (Core or Project)
get_team_role() {
    print_color "Which team are you on?" "blue"
    echo "  1) Core"
    echo "  2) Project"

    ROLE=""
    while [ -z "$ROLE" ]; do
        printf "Enter number and press [ENTER]: "
        read -r choice
        case "$choice" in
            1) ROLE="Core" ;;
            2) ROLE="Project" ;;
            *) print_color "Invalid selection. Please enter 1 or 2." "red" ;;
        esac
    done

    # Replace the placeholder in the generated file
    # Uses a temporary file for safety
    sed "s/{Core\/Project}/${ROLE}/g" "$OUTPUT_FILE" > "${OUTPUT_FILE}.tmp" && mv "${OUTPUT_FILE}.tmp" "$OUTPUT_FILE"

    print_color "Role updated to '${ROLE}' in the rules file." "green"
}

# Prompts the user to select their IDE
get_ide_selection() {
    print_color "\nPlease select your IDE for setup instructions:" "blue"
    echo "  1) PhpStorm+Copilot"
    echo "  2) VSCode+Copilot"
    echo "  3) Cursor"
    echo "  4) Windsurf"
    echo "  5) Skip"

    ide=""
    while [ -z "$ide" ]; do
        printf "Enter number and press [ENTER]: "
        read -r choice
        case "$choice" in
            1) ide="PhpStorm+Copilot" ;;
            2) ide="VSCode+Copilot" ;;
            3) ide="Cursor" ;;
            4) ide="Windsurf" ;;
            5) ide="Skip" ;;
            *) print_color "Invalid selection. Please try again." "red" ;;
        esac
    done

    if [ "$ide" != "Skip" ]; then
        display_ide_instructions "$ide"
    fi
}

# Displays the setup instructions for the chosen IDE
display_ide_instructions() {
    ide="$1"
    print_color "\n--- Global setup instructions for ${ide} ---" "yellow"

    case "$ide" in
        "PhpStorm+Copilot")
            print_color "Set up global rules in PhpStorm with GitHub Copilot:" "yellow"
            echo "1. Open: Settings / Preferences -> Tools -> GitHub Copilot -> Customizations."
            echo "2. Click the '+' icon to add a new customization."
            echo "3. Choose 'Custom Rules'."
            echo "4. Open '${OUTPUT_FILE}' in your editor, copy its content."
            echo "5. Paste the copied text into the customization rules field."
            echo "6. Save. Copilot will now always apply these rules globally."
            ;;
        "VSCode+Copilot")
            print_color "Set up global rules in VSCode with GitHub Copilot:" "yellow"
            echo "1. Open global VSCode settings (user-level, not workspace)."
            echo "2. Search for 'Copilot Chat: Custom Instructions'."
            echo "3. Open 'settings.json' (user)."
            echo "4. Open '${OUTPUT_FILE}' and copy its content."
            echo "5. Paste everything inside the 'github.copilot.chat.instructions' section."
            echo "6. Save the file. These rules are now globally applied to all projects."
            ;;
        "Cursor")
            print_color "Set up global rules in Cursor:" "yellow"
            echo "1. Open Command Palette (Cmd+K / Ctrl+K)."
            echo "2. Type 'Preferences: Open User Settings (JSON)'."
            echo "3. Locate AI / Copilot / Assistant section."
            echo "4. Open '${OUTPUT_FILE}' and copy its content."
            echo "5. Paste the copied text into the global 'instructions' or 'rules' field."
            echo "6. Save. Cursor will now always use these rules across all workspaces."
            ;;
        "Windsurf")
            print_color "Set up global rules in Windsurf (generic instruction):" "yellow"
            echo "1. Open Settings -> AI / Copilot / Assistant configuration."
            echo "2. Look for 'Global Instructions' or 'Custom Rules'."
            echo "3. Open '${OUTPUT_FILE}' and copy its content."
            echo "4. Paste it into the global rules field."
            echo "5. Save changes. The rules will apply to all projects automatically."
            ;;
    esac
}
# --- Main Execution ---
main() {
    print_color "===============================================" "green"
    print_color "  Spryker AI Prompt Rules Setup Utility" "green"
    print_color "===============================================" "green"
    echo ""

    fetch_and_combine_rules
    echo ""
    get_team_role
    echo ""
    get_ide_selection

    echo ""
    print_color "Setup complete! Your customized rules file is ready at '${OUTPUT_FILE}'." "blue"
    print_color "You can now use this file as context for your AI assistant." "blue"
}

# Run the main function
main
